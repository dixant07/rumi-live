!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.RumiBot=t():e.RumiBot=t()}(this,()=>(()=>{"use strict";var e={164(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.NetworkProtocol=t.MSG_TYPE=void 0,t.MSG_TYPE={BAT_UPDATE:1,HIT_EVENT:2,SCORE_UPDATE:3,PING:4},t.NetworkProtocol=class{static encode(e){switch(e.type){case"bat":return this.encodeBatUpdate(e);case"hit":return this.encodeHitEvent(e);case"score":return this.encodeScoreUpdate(e);case"ping":return this.encodePing(e);default:return console.error("Unknown message type for encoding:",e.type),null}}static decode(e){const n=new DataView(e),s=n.getUint8(0);switch(s){case t.MSG_TYPE.BAT_UPDATE:return this.decodeBatUpdate(n);case t.MSG_TYPE.HIT_EVENT:return this.decodeHitEvent(n);case t.MSG_TYPE.SCORE_UPDATE:return this.decodeScoreUpdate(n);case t.MSG_TYPE.PING:return{type:"ping"};default:return console.error("Unknown message type for decoding:",s),null}}static encodeBatUpdate(e){const n=new ArrayBuffer(18),s=new DataView(n);return s.setUint8(0,t.MSG_TYPE.BAT_UPDATE),s.setUint8(1,"A"===e.role?1:2),s.setFloat32(2,e.x),s.setFloat32(6,e.y),s.setFloat32(10,e.vx||0),s.setFloat32(14,e.vy||0),n}static encodeHitEvent(e){const n=new ArrayBuffer(30),s=new DataView(n);s.setUint8(0,t.MSG_TYPE.HIT_EVENT);const i=e.state;return s.setFloat32(1,i.x),s.setFloat32(5,i.y),s.setFloat32(9,i.z),s.setFloat32(13,i.vx),s.setFloat32(17,i.vy),s.setFloat32(21,i.vz),s.setFloat32(25,i.spin||0),s.setUint8(29,e.isServing?1:0),n}static encodeScoreUpdate(e){const n=new ArrayBuffer(6),s=new DataView(n);return s.setUint8(0,t.MSG_TYPE.SCORE_UPDATE),s.setUint16(1,e.scoreA),s.setUint16(3,e.scoreB),s.setUint8(5,"A"===e.currentServer?1:2),n}static encodePing(e){const n=new ArrayBuffer(1);return new DataView(n).setUint8(0,t.MSG_TYPE.PING),n}static decodeBatUpdate(e){return{type:"bat",role:1===e.getUint8(1)?"A":"B",x:e.getFloat32(2),y:e.getFloat32(6),vx:e.getFloat32(10),vy:e.getFloat32(14)}}static decodeHitEvent(e){return{type:"hit",state:{x:e.getFloat32(1),y:e.getFloat32(5),z:e.getFloat32(9),vx:e.getFloat32(13),vy:e.getFloat32(17),vz:e.getFloat32(21),spin:e.getFloat32(25)},isServing:1===e.getUint8(29)}}static decodeScoreUpdate(e){return{type:"score",scoreA:e.getUint16(1),scoreB:e.getUint16(3),currentServer:1===e.getUint8(5)?"A":"B"}}}},202(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.KnifeThrowAI=void 0;const s=n(993);t.KnifeThrowAI=class{constructor(){this.knivesRemaining=6,this.stuckAngles=[],this.discRotation=0,this.discSpeed=4,this.discDirection=1,this.lastThrowTime=0,this.throwCooldown=1500,this.roundStarted=!1,this.isWaitingForResult=!1,this.difficulty=.85,this.reactionTime=500,this.minAngleSeparation=15,console.log("[KnifeThrowAI] Initialized")}onMessage(e){const t=s.KnifeThrowNetworkProtocol.decode(e);if(t)switch(console.log("[KnifeThrowAI] Received message:",t.type),t.type){case"round_setup":this.handleRoundSetup(t.dummyKnives);break;case"rotation_update":this.discSpeed=t.speed,this.discDirection=t.direction,console.log("[KnifeThrowAI] Rotation update - speed:",this.discSpeed,"dir:",this.discDirection);break;case"throw_knife":t.success&&(this.stuckAngles.push(t.angle),console.log("[KnifeThrowAI] Opponent knife stuck at angle:",t.angle))}}handleRoundSetup(e){console.log("[KnifeThrowAI] Round setup with dummy knives:",e),this.stuckAngles=[...e],this.knivesRemaining=6,this.roundStarted=!0,this.isWaitingForResult=!1,this.lastThrowTime=Date.now()+this.reactionTime}tick(e){const t=[],n=Date.now();if(this.discRotation+=this.discSpeed*this.discDirection*e,this.discRotation=(this.discRotation%360+360)%360,this.shouldThrow(n)){const e=this.performThrow(n);t.push(...e)}return t}shouldThrow(e){return!(e-this.lastThrowTime<this.throwCooldown)&&!!this.roundStarted&&!(this.knivesRemaining<=0)&&!this.isWaitingForResult&&this.isSafeToThrow()}isSafeToThrow(){const e=this.getImpactAngle();return this.isAngleSafe(e)}getImpactAngle(){return(90-this.discRotation+360)%360}isAngleSafe(e){for(const t of this.stuckAngles)if(this.angleDifference(e,t)<this.minAngleSeparation)return!1;return!0}angleDifference(e,t){let n=Math.abs(e-t);return n>180&&(n=360-n),n}performThrow(e){const t=[];this.lastThrowTime=e,this.isWaitingForResult=!0;const n=this.calculateThrowResult();console.log("[KnifeThrowAI] Throwing knife - angle:",n.angle,"success:",n.success);const i=s.KnifeThrowNetworkProtocol.encodeThrowStart({type:"throw_start",timestamp:e});i&&t.push(i);const o=s.KnifeThrowNetworkProtocol.encodeThrowKnife({type:"throw_knife",angle:n.angle,success:n.success,timestamp:e+300});return o&&t.push(o),this.knivesRemaining--,n.success&&this.stuckAngles.push(n.angle),setTimeout(()=>{this.isWaitingForResult=!1},500),t}calculateThrowResult(){const e=this.getImpactAngle();return this.isAngleSafe(e)?{angle:e,success:Math.random()<this.difficulty}:{angle:e,success:!1}}reset(){this.knivesRemaining=6,this.stuckAngles=[],this.discRotation=0,this.discSpeed=4,this.discDirection=1,this.lastThrowTime=0,this.roundStarted=!1,this.isWaitingForResult=!1}}},436(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.PingPongAI=void 0;const s=n(164);t.PingPongAI=class{constructor(e){this.ball={x:0,y:0,z:0,vx:0,vy:0,vz:0,spin:0},this.paddle={x:0,y:0,vx:0,vy:0},this.isServing=!0,this.currentServer="A",this.TABLE_WIDTH=300,this.TABLE_LENGTH=480,this.BAT_Y_A=240,this.BAT_Y_B=-240,this.MOVE_SPEED=250,this.difficulty=.8,this.lastUpdate=0,this.lastHitTime=0,this.role=e,this.paddle.y=this.BAT_Y_A,this.paddle.x=0,this.currentServer===this.role&&this.prepareServe()}toNetwork(e){return"B"===this.role?{x:-e.x,y:-e.y,z:e.z,vx:-e.vx,vy:-e.vy,vz:e.vz,spin:e.spin}:e}prepareServe(){this.currentServer===this.role&&(this.isServing=!0,this.ball={x:0,y:this.paddle.y-20,z:80,vx:0,vy:0,vz:0,spin:0})}fromNetwork(e){return"B"===this.role?{x:-e.x,y:-e.y,z:e.z,vx:-e.vx,vy:-e.vy,vz:e.vz,spin:e.spin}:e}onMessage(e){const t=s.NetworkProtocol.decode(e);if(t)if(console.log("[PingPongAI] Received message:",t.type),"hit"===t.type){const e=this.fromNetwork(t.state);console.log("[PingPongAI] Hit received, ball:",e.x,e.y,"vy:",e.vy),this.ball={...e},this.isServing=t.isServing}else"score"===t.type&&(this.currentServer=t.currentServer,this.currentServer===this.role?this.prepareServe():this.isServing=!1)}tick(e){const t=[],n=Date.now();this.simulateBall(e),this.isServing&&this.currentServer===this.role?n-this.lastHitTime>1e3&&this.performServe(t):(this.updatePaddleMovement(e),this.checkCollision(t));const i="B"===this.role?-this.paddle.x:this.paddle.x,o="B"===this.role?-this.paddle.y:this.paddle.y,a="B"===this.role?-this.paddle.vx:this.paddle.vx,r="B"===this.role?-this.paddle.vy:this.paddle.vy;return t.push(s.NetworkProtocol.encodeBatUpdate({role:this.role,x:i,y:o,vx:a,vy:r})),this.lastUpdate=n,t}simulateBall(e){this.ball.vz-=400*e,this.ball.x+=this.ball.vx*e,this.ball.y+=this.ball.vy*e,this.ball.z+=this.ball.vz*e,this.ball.z<0&&(this.ball.z=0,this.ball.vz=.9*-this.ball.vz,Math.abs(this.ball.vz)<50&&(this.ball.vz=0))}updatePaddleMovement(e){let t=0;if(this.ball.vy>0){t=this.ball.x;const e=this.TABLE_WIDTH/2+50;t>e&&(t=e),t<-e&&(t=-e)}else t=0;const n=t-this.paddle.x,s=this.MOVE_SPEED*e;if(Math.abs(n)<s)this.paddle.x=t,this.paddle.vx=n/e;else{const e=Math.sign(n);this.paddle.x+=e*s,this.paddle.vx=e*this.MOVE_SPEED}}checkCollision(e){const t=Date.now();if(t-this.lastHitTime<500)return;const n=Math.abs(this.ball.y-this.paddle.y),i=Math.abs(this.ball.x-this.paddle.x);if(n<30&&i<40&&this.ball.z<100){if(!(this.ball.vy>0))return;this.lastHitTime=t;const n=(Math.random()-.5)*(.8*this.TABLE_WIDTH),i=-(this.TABLE_LENGTH/2-40),o=450;this.ball.vy=-o;const a=Math.abs((i-this.ball.y)/this.ball.vy);this.ball.vx=(n-this.ball.x)/a,this.ball.vz=250,e.push(s.NetworkProtocol.encodeHitEvent({state:this.toNetwork(this.ball),isServing:!1}))}}performServe(e){this.lastHitTime=Date.now(),this.ball.x=this.paddle.x,this.ball.y=this.paddle.y-20,this.ball.z=80,this.ball.vy=-400,this.ball.vx=100*(Math.random()-.5),this.ball.vz=200,this.isServing=!1,e.push(s.NetworkProtocol.encodeHitEvent({state:this.toNetwork(this.ball),isServing:!0}))}}},563(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,s,i)}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),i=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||s(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),i(n(202),t),i(n(993),t)},673(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.BotClient=void 0;const s=n(756);t.BotClient=class{constructor(e,t=""){this.gameAI=null,this.gameType=null,this.role="B",this.gameLoopInterval=null,this.gameChannelReliable=null,this.gameChannelUnreliable=null,this.chatChannel=null,this.persona=e,this.backendUrl=t||window.location.origin,console.log(`[BotClient] Created bot: ${e.name}`)}getPersona(){return this.persona}setRole(e){this.role=e,this.gameType?this.gameAI=s.GameFactory.createGame(this.gameType,e):(console.log(`[BotClient] Role set to ${e}, but no game type set. Waiting for game type.`),this.gameAI=null)}setGameType(e){this.gameType=e,console.log(`[BotClient] Game type set to: ${e}`),this.role&&(this.gameAI=s.GameFactory.createGame(this.gameType,this.role))}setupGameChannel(e){const t=e.label;console.log(`[BotClient] Setting up game channel: ${t}`),"game_reliable"===t?this.gameChannelReliable=e:this.gameChannelUnreliable=e,e.binaryType="arraybuffer",e.onopen=()=>{console.log(`[BotClient] Game channel ${t} OPEN`),"game_unreliable"!==t&&this.gameChannelReliable||this.startGameLoop()},e.onmessage=e=>{if(this.gameAI){let t;if(e.data instanceof ArrayBuffer)t=e.data;else{if(e.data instanceof Blob)return void e.data.arrayBuffer().then(e=>{var t;null===(t=this.gameAI)||void 0===t||t.onMessage(e)});t=e.data}this.gameAI.onMessage(t)}},e.onclose=()=>{console.log(`[BotClient] Game channel ${t} CLOSED`),"game_unreliable"===t&&this.stopGameLoop()}}setupChatChannel(e){this.chatChannel=e,e.onopen=()=>{console.log("[BotClient] Chat channel OPEN"),this.sendBotInfo(),this.sendGreeting()},e.onmessage=async e=>{await this.handleChatMessage(e.data)},e.onclose=()=>{console.log("[BotClient] Chat channel CLOSED")}}startGameLoop(){this.gameLoopInterval&&clearInterval(this.gameLoopInterval),console.log("[BotClient] Starting game loop"),this.gameLoopInterval=window.setInterval(()=>{const e=this.gameChannelUnreliable||this.gameChannelReliable;if(this.gameAI&&(!e||e.readyState),this.gameAI&&e&&"open"===e.readyState){const t=1/60,n=this.gameAI.tick(t);n.length>0&&Math.random()<.01&&console.log(`[BotClient] Sending ${n.length} messages (Sample)`),n.forEach(t=>{try{e.send(t)}catch(e){console.error("[BotClient] Send error:",e)}})}},1e3/60)}stopGameLoop(){this.gameLoopInterval&&(clearInterval(this.gameLoopInterval),this.gameLoopInterval=null)}sendBotInfo(){if(this.chatChannel&&"open"===this.chatChannel.readyState){const e={type:"bot_info",payload:{id:this.persona.id,name:this.persona.name,avatar:this.persona.avatar}};this.chatChannel.send(JSON.stringify(e))}}async sendGreeting(){try{const e=await this.getLLMResponse(`Say a short, friendly greeting as ${this.persona.name}. Just one sentence, be casual and welcoming.`);this.chatChannel&&"open"===this.chatChannel.readyState&&this.chatChannel.send(JSON.stringify({type:"chat",payload:e,sender:"bot"}))}catch(e){console.error("[BotClient] Greeting error:",e),this.chatChannel&&"open"===this.chatChannel.readyState&&this.chatChannel.send(JSON.stringify({type:"chat",payload:`Hey there! I'm ${this.persona.name}. Nice to meet you! ðŸ‘‹`,sender:"bot"}))}}async handleChatMessage(e){try{const t="string"==typeof e?e:(new TextDecoder).decode(e);let n=t;try{const e=JSON.parse(t);if("game_invite"===e.type)return console.log("[BotClient] Received game invite:",e.payload),void(this.chatChannel&&"open"===this.chatChannel.readyState&&(console.log("[BotClient] Auto-accepting game invite"),this.chatChannel.send(JSON.stringify({type:"game_accept",payload:e.payload}))));if("game_accept"===e.type||"game_reject"===e.type||"game_leave"===e.type||"game_cancel"===e.type)return void console.log("[BotClient] Game control message:",e.type);if("chat"===e.type)n=e.payload;else if(e.content)n=e.content;else{if(!e.message)return;n=e.message}}catch(e){}const s=await this.getLLMResponse(n),i=Math.min(Math.max(30*s.length,2e3),5e3);await new Promise(e=>setTimeout(e,i)),this.chatChannel&&"open"===this.chatChannel.readyState&&this.chatChannel.send(JSON.stringify({type:"chat",payload:s,sender:"bot"}))}catch(e){console.error("[BotClient] Chat error:",e)}}sendTypingIndicator(e){this.chatChannel&&"open"===this.chatChannel.readyState&&this.chatChannel.send(JSON.stringify({type:"typing",payload:{isTyping:e}}))}async getLLMResponse(e){try{const t=await fetch(`${this.backendUrl}/api/bot-chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({systemPrompt:this.persona.systemPrompt,message:e})});if(!t.ok)throw new Error(`API error: ${t.status}`);return(await t.json()).response||"Hmm, let me think..."}catch(e){console.error("[BotClient] LLM API error:",e);const t=["Nice move!","Good game!","Let's keep playing!","You're doing great!","That was close!"];return t[Math.floor(Math.random()*t.length)]}}cleanup(){this.stopGameLoop(),this.gameChannelReliable&&(this.gameChannelReliable.close(),this.gameChannelReliable=null),this.gameChannelUnreliable&&(this.gameChannelUnreliable.close(),this.gameChannelUnreliable=null),this.chatChannel&&(this.chatChannel.close(),this.chatChannel=null),this.gameAI=null,console.log("[BotClient] Cleaned up")}}},682(e,t,n){var s=this&&this.__createBinding||(Object.create?function(e,t,n,s){void 0===s&&(s=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,s,i)}:function(e,t,n,s){void 0===s&&(s=n),e[s]=t[n]}),i=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||s(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),i(n(436),t),i(n(164),t)},756(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.GameFactory=void 0;const s=n(682),i=n(563);t.GameFactory=class{static createGame(e,t="B"){switch(e){case"ping-pong":return console.log("[GameFactory] Creating PingPongAI"),new s.PingPongAI(t);case"knife-throw":return console.log("[GameFactory] Creating KnifeThrowAI"),new i.KnifeThrowAI;default:return console.log("[GameFactory] Unknown or null game type:",e),null}}}},993(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.KnifeThrowNetworkProtocol=t.MSG_TYPE=void 0,t.MSG_TYPE={THROW_KNIFE:1,THROW_START:2,ROUND_SETUP:3,ROTATION_UPDATE:4,PING:5},t.KnifeThrowNetworkProtocol=class{static encode(e){switch(e.type){case"throw_knife":return this.encodeThrowKnife(e);case"throw_start":return this.encodeThrowStart(e);case"round_setup":return this.encodeRoundSetup(e);case"rotation_update":return this.encodeRotationUpdate(e);case"ping":return this.encodePing(e);default:return console.error("Unknown message type for encoding:",e.type),null}}static decode(e){const n=new DataView(e),s=n.getUint8(0);switch(s){case t.MSG_TYPE.THROW_KNIFE:return this.decodeThrowKnife(n);case t.MSG_TYPE.THROW_START:return this.decodeThrowStart(n);case t.MSG_TYPE.ROUND_SETUP:return this.decodeRoundSetup(n);case t.MSG_TYPE.ROTATION_UPDATE:return this.decodeRotationUpdate(n);case t.MSG_TYPE.PING:return{type:"ping"};default:return console.error("Unknown message type for decoding:",s),null}}static encodeThrowKnife(e){const n=new ArrayBuffer(8),s=new DataView(n);return s.setUint8(0,t.MSG_TYPE.THROW_KNIFE),s.setUint16(1,Math.round(100*e.angle)),s.setUint8(3,e.success?1:0),s.setUint32(4,e.timestamp),n}static encodeThrowStart(e){const n=new ArrayBuffer(5),s=new DataView(n);return s.setUint8(0,t.MSG_TYPE.THROW_START),s.setUint32(1,e.timestamp),n}static encodeRoundSetup(e){const n=e.dummyKnives.length,s=new ArrayBuffer(2+2*n),i=new DataView(s);i.setUint8(0,t.MSG_TYPE.ROUND_SETUP),i.setUint8(1,n);for(let t=0;t<n;t++)i.setUint16(2+2*t,Math.round(100*e.dummyKnives[t]));return s}static encodeRotationUpdate(e){const n=new ArrayBuffer(8),s=new DataView(n);return s.setUint8(0,t.MSG_TYPE.ROTATION_UPDATE),s.setUint16(1,Math.round(1e3*e.speed)),s.setInt8(3,e.direction),s.setUint32(4,e.timestamp),n}static encodePing(e){const n=new ArrayBuffer(1);return new DataView(n).setUint8(0,t.MSG_TYPE.PING),n}static decodeThrowKnife(e){return{type:"throw_knife",angle:e.getUint16(1)/100,success:1===e.getUint8(3),timestamp:e.getUint32(4)}}static decodeThrowStart(e){return{type:"throw_start",timestamp:e.getUint32(1)}}static decodeRoundSetup(e){const t=e.getUint8(1),n=[];for(let s=0;s<t;s++)n.push(e.getUint16(2+2*s)/100);return{type:"round_setup",dummyKnives:n}}static decodeRotationUpdate(e){return{type:"rotation_update",speed:e.getUint16(1)/1e3,direction:e.getInt8(3),timestamp:e.getUint32(4)}}}}},t={};function n(s){var i=t[s];if(void 0!==i)return i.exports;var o=t[s]={exports:{}};return e[s].call(o.exports,o,o.exports,n),o.exports}var s={};return(()=>{var e=s;const t=n(673);e.default=t.BotClient})(),s.default})());