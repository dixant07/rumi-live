!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.RumiBot=e():t.RumiBot=e()}(this,()=>(()=>{"use strict";var t={369(t,e){Object.defineProperty(e,"__esModule",{value:!0}),e.NetworkProtocol=e.MSG_TYPE=void 0,e.MSG_TYPE={BAT_UPDATE:1,HIT_EVENT:2,SCORE_UPDATE:3,PING:4},e.NetworkProtocol=class{static encode(t){switch(t.type){case"bat":return this.encodeBatUpdate(t);case"hit":return this.encodeHitEvent(t);case"score":return this.encodeScoreUpdate(t);case"ping":return this.encodePing(t);default:return console.error("Unknown message type for encoding:",t.type),null}}static decode(t){const s=new DataView(t),a=s.getUint8(0);switch(a){case e.MSG_TYPE.BAT_UPDATE:return this.decodeBatUpdate(s);case e.MSG_TYPE.HIT_EVENT:return this.decodeHitEvent(s);case e.MSG_TYPE.SCORE_UPDATE:return this.decodeScoreUpdate(s);case e.MSG_TYPE.PING:return{type:"ping"};default:return console.error("Unknown message type for decoding:",a),null}}static encodeBatUpdate(t){const s=new ArrayBuffer(18),a=new DataView(s);return a.setUint8(0,e.MSG_TYPE.BAT_UPDATE),a.setUint8(1,"A"===t.role?1:2),a.setFloat32(2,t.x),a.setFloat32(6,t.y),a.setFloat32(10,t.vx||0),a.setFloat32(14,t.vy||0),s}static encodeHitEvent(t){const s=new ArrayBuffer(30),a=new DataView(s);a.setUint8(0,e.MSG_TYPE.HIT_EVENT);const n=t.state;return a.setFloat32(1,n.x),a.setFloat32(5,n.y),a.setFloat32(9,n.z),a.setFloat32(13,n.vx),a.setFloat32(17,n.vy),a.setFloat32(21,n.vz),a.setFloat32(25,n.spin||0),a.setUint8(29,t.isServing?1:0),s}static encodeScoreUpdate(t){const s=new ArrayBuffer(6),a=new DataView(s);return a.setUint8(0,e.MSG_TYPE.SCORE_UPDATE),a.setUint16(1,t.scoreA),a.setUint16(3,t.scoreB),a.setUint8(5,"A"===t.currentServer?1:2),s}static encodePing(t){const s=new ArrayBuffer(1);return new DataView(s).setUint8(0,e.MSG_TYPE.PING),s}static decodeBatUpdate(t){return{type:"bat",role:1===t.getUint8(1)?"A":"B",x:t.getFloat32(2),y:t.getFloat32(6),vx:t.getFloat32(10),vy:t.getFloat32(14)}}static decodeHitEvent(t){return{type:"hit",state:{x:t.getFloat32(1),y:t.getFloat32(5),z:t.getFloat32(9),vx:t.getFloat32(13),vy:t.getFloat32(17),vz:t.getFloat32(21),spin:t.getFloat32(25)},isServing:1===t.getUint8(29)}}static decodeScoreUpdate(t){return{type:"score",scoreA:t.getUint16(1),scoreB:t.getUint16(3),currentServer:1===t.getUint8(5)?"A":"B"}}}},659(t,e,s){Object.defineProperty(e,"__esModule",{value:!0}),e.PingPongAI=void 0;const a=s(369);e.PingPongAI=class{constructor(t){this.ball={x:0,y:0,z:0,vx:0,vy:0,vz:0,spin:0},this.paddle={x:0,y:0,vx:0,vy:0},this.isServing=!0,this.currentServer="A",this.TABLE_WIDTH=300,this.TABLE_LENGTH=480,this.BAT_Y_A=240,this.BAT_Y_B=-240,this.MOVE_SPEED=250,this.difficulty=.8,this.lastUpdate=0,this.lastHitTime=0,this.role=t,this.paddle.y="A"===t?this.BAT_Y_A:this.BAT_Y_B,this.paddle.x=0,"A"===this.role&&this.prepareServe()}prepareServe(){this.currentServer===this.role&&(this.isServing=!0,this.ball={x:0,y:this.paddle.y-("A"===this.role?20:-20),z:80,vx:0,vy:0,vz:0,spin:0})}onMessage(t){const e=a.NetworkProtocol.decode(t);if(e)if("hit"===e.type){const t=e.state;this.ball={...t},this.isServing=e.isServing}else"score"===e.type&&(this.currentServer=e.currentServer,this.currentServer===this.role?this.prepareServe():this.isServing=!1)}tick(t){const e=[],s=Date.now();return this.simulateBall(t),this.isServing&&this.currentServer===this.role?s-this.lastHitTime>1e3&&this.performServe(e):(this.updatePaddleMovement(t),this.checkCollision(e)),e.push(a.NetworkProtocol.encodeBatUpdate({role:this.role,x:this.paddle.x,y:this.paddle.y,vx:this.paddle.vx,vy:this.paddle.vy})),this.lastUpdate=s,e}simulateBall(t){this.ball.vz-=400*t,this.ball.x+=this.ball.vx*t,this.ball.y+=this.ball.vy*t,this.ball.z+=this.ball.vz*t,this.ball.z<0&&(this.ball.z=0,this.ball.vz=.9*-this.ball.vz,Math.abs(this.ball.vz)<50&&(this.ball.vz=0))}updatePaddleMovement(t){let e=0;if("A"===this.role&&this.ball.vy<0||"B"===this.role&&this.ball.vy>0){e=this.ball.x;const t=this.TABLE_WIDTH/2+50;e>t&&(e=t),e<-t&&(e=-t)}else e=0;const s=e-this.paddle.x,a=this.MOVE_SPEED*t;if(Math.abs(s)<a)this.paddle.x=e,this.paddle.vx=s/t;else{const t=Math.sign(s);this.paddle.x+=t*a,this.paddle.vx=t*this.MOVE_SPEED}}checkCollision(t){const e=Date.now();if(e-this.lastHitTime<500)return;const s=Math.abs(this.ball.y-this.paddle.y),n=Math.abs(this.ball.x-this.paddle.x);if(s<30&&n<40&&this.ball.z<100){if(!("A"===this.role&&this.ball.vy<0||"B"===this.role&&this.ball.vy>0))return;this.lastHitTime=e;const s="A"===this.role?1:-1,n=(Math.random()-.5)*(.8*this.TABLE_WIDTH),i=s*(this.TABLE_LENGTH/2-40),o=450;this.ball.vy=s*o;const l=Math.abs((i-this.ball.y)/this.ball.vy);this.ball.vx=(n-this.ball.x)/l,this.ball.vz=250,t.push(a.NetworkProtocol.encodeHitEvent({state:this.ball,isServing:!1}))}}performServe(t){this.lastHitTime=Date.now();const e="A"===this.role?1:-1;this.ball.x=this.paddle.x,this.ball.y=this.paddle.y+20*e,this.ball.z=80,this.ball.vy=400*e,this.ball.vx=100*(Math.random()-.5),this.ball.vz=200,this.isServing=!1,t.push(a.NetworkProtocol.encodeHitEvent({state:this.ball,isServing:!0}))}}},673(t,e,s){Object.defineProperty(e,"__esModule",{value:!0}),e.BotClient=void 0;const a=s(659);e.BotClient=class{constructor(t,e=""){this.gameAI=null,this.role="B",this.gameLoopInterval=null,this.gameChannel=null,this.chatChannel=null,this.persona=t,this.backendUrl=e||window.location.origin,console.log(`[BotClient] Created bot: ${t.name}`)}getPersona(){return this.persona}setRole(t){this.role=t,this.gameAI=new a.PingPongAI(t),console.log(`[BotClient] Role set to ${t}, initialized PingPongAI`)}setupGameChannel(t){this.gameChannel=t,t.onopen=()=>{console.log("[BotClient] Game channel OPEN"),this.startGameLoop()},t.onmessage=t=>{if(this.gameAI){let e;if(t.data instanceof ArrayBuffer)e=t.data;else{if(t.data instanceof Blob)return void t.data.arrayBuffer().then(t=>{var e;null===(e=this.gameAI)||void 0===e||e.onMessage(t)});e=t.data}this.gameAI.onMessage(e)}},t.onclose=()=>{console.log("[BotClient] Game channel CLOSED"),this.stopGameLoop()}}setupChatChannel(t){this.chatChannel=t,t.onopen=()=>{console.log("[BotClient] Chat channel OPEN"),this.sendBotInfo(),this.sendGreeting()},t.onmessage=async t=>{await this.handleChatMessage(t.data)},t.onclose=()=>{console.log("[BotClient] Chat channel CLOSED")}}startGameLoop(){this.gameLoopInterval&&clearInterval(this.gameLoopInterval),this.gameLoopInterval=window.setInterval(()=>{if(this.gameAI&&this.gameChannel&&"open"===this.gameChannel.readyState){const t=1/60;this.gameAI.tick(t).forEach(t=>{var e;try{null===(e=this.gameChannel)||void 0===e||e.send(t)}catch(t){}})}},1e3/60)}stopGameLoop(){this.gameLoopInterval&&(clearInterval(this.gameLoopInterval),this.gameLoopInterval=null)}sendBotInfo(){if(this.chatChannel&&"open"===this.chatChannel.readyState){const t={type:"bot_info",payload:{id:this.persona.id,name:this.persona.name,avatar:this.persona.avatar}};this.chatChannel.send(JSON.stringify(t))}}async sendGreeting(){try{const t=await this.getLLMResponse(`Say a short, friendly greeting as ${this.persona.name}. Just one sentence, be casual and welcoming.`);this.chatChannel&&"open"===this.chatChannel.readyState&&this.chatChannel.send(JSON.stringify({type:"chat",payload:t,sender:"bot"}))}catch(t){console.error("[BotClient] Greeting error:",t),this.chatChannel&&"open"===this.chatChannel.readyState&&this.chatChannel.send(JSON.stringify({type:"chat",payload:`Hey there! I'm ${this.persona.name}. Nice to meet you! ðŸ‘‹`,sender:"bot"}))}}async handleChatMessage(t){try{const e="string"==typeof t?t:(new TextDecoder).decode(t);let s=e;try{const t=JSON.parse(e);"chat"===t.type?s=t.payload:t.content?s=t.content:t.message&&(s=t.message)}catch(t){}const a=await this.getLLMResponse(s),n=Math.min(Math.max(30*a.length,500),3e3);await new Promise(t=>setTimeout(t,n)),this.chatChannel&&"open"===this.chatChannel.readyState&&this.chatChannel.send(JSON.stringify({type:"chat",payload:a,sender:"bot"}))}catch(t){console.error("[BotClient] Chat error:",t)}}sendTypingIndicator(t){this.chatChannel&&"open"===this.chatChannel.readyState&&this.chatChannel.send(JSON.stringify({type:"typing",payload:{isTyping:t}}))}async getLLMResponse(t){try{const e=await fetch(`${this.backendUrl}/api/bot-chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({systemPrompt:this.persona.systemPrompt,message:t})});if(!e.ok)throw new Error(`API error: ${e.status}`);return(await e.json()).response||"Hmm, let me think..."}catch(t){console.error("[BotClient] LLM API error:",t);const e=["Nice move!","Good game!","Let's keep playing!","You're doing great!","That was close!"];return e[Math.floor(Math.random()*e.length)]}}cleanup(){this.stopGameLoop(),this.gameChannel&&(this.gameChannel.close(),this.gameChannel=null),this.chatChannel&&(this.chatChannel.close(),this.chatChannel=null),this.gameAI=null,console.log("[BotClient] Cleaned up")}}}},e={};function s(a){var n=e[a];if(void 0!==n)return n.exports;var i=e[a]={exports:{}};return t[a](i,i.exports,s),i.exports}var a={};return(()=>{var t=a;const e=s(673);s(659),s(369);t.default=e.BotClient})(),a.default})());