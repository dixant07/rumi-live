!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.RumiBot=t():e.RumiBot=t()}(this,()=>(()=>{"use strict";var e={369(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.NetworkProtocol=t.MSG_TYPE=void 0,t.MSG_TYPE={BAT_UPDATE:1,HIT_EVENT:2,SCORE_UPDATE:3,PING:4},t.NetworkProtocol=class{static encode(e){switch(e.type){case"bat":return this.encodeBatUpdate(e);case"hit":return this.encodeHitEvent(e);case"score":return this.encodeScoreUpdate(e);case"ping":return this.encodePing(e);default:return console.error("Unknown message type for encoding:",e.type),null}}static decode(e){const a=new DataView(e),s=a.getUint8(0);switch(s){case t.MSG_TYPE.BAT_UPDATE:return this.decodeBatUpdate(a);case t.MSG_TYPE.HIT_EVENT:return this.decodeHitEvent(a);case t.MSG_TYPE.SCORE_UPDATE:return this.decodeScoreUpdate(a);case t.MSG_TYPE.PING:return{type:"ping"};default:return console.error("Unknown message type for decoding:",s),null}}static encodeBatUpdate(e){const a=new ArrayBuffer(18),s=new DataView(a);return s.setUint8(0,t.MSG_TYPE.BAT_UPDATE),s.setUint8(1,"A"===e.role?1:2),s.setFloat32(2,e.x),s.setFloat32(6,e.y),s.setFloat32(10,e.vx||0),s.setFloat32(14,e.vy||0),a}static encodeHitEvent(e){const a=new ArrayBuffer(30),s=new DataView(a);s.setUint8(0,t.MSG_TYPE.HIT_EVENT);const n=e.state;return s.setFloat32(1,n.x),s.setFloat32(5,n.y),s.setFloat32(9,n.z),s.setFloat32(13,n.vx),s.setFloat32(17,n.vy),s.setFloat32(21,n.vz),s.setFloat32(25,n.spin||0),s.setUint8(29,e.isServing?1:0),a}static encodeScoreUpdate(e){const a=new ArrayBuffer(6),s=new DataView(a);return s.setUint8(0,t.MSG_TYPE.SCORE_UPDATE),s.setUint16(1,e.scoreA),s.setUint16(3,e.scoreB),s.setUint8(5,"A"===e.currentServer?1:2),a}static encodePing(e){const a=new ArrayBuffer(1);return new DataView(a).setUint8(0,t.MSG_TYPE.PING),a}static decodeBatUpdate(e){return{type:"bat",role:1===e.getUint8(1)?"A":"B",x:e.getFloat32(2),y:e.getFloat32(6),vx:e.getFloat32(10),vy:e.getFloat32(14)}}static decodeHitEvent(e){return{type:"hit",state:{x:e.getFloat32(1),y:e.getFloat32(5),z:e.getFloat32(9),vx:e.getFloat32(13),vy:e.getFloat32(17),vz:e.getFloat32(21),spin:e.getFloat32(25)},isServing:1===e.getUint8(29)}}static decodeScoreUpdate(e){return{type:"score",scoreA:e.getUint16(1),scoreB:e.getUint16(3),currentServer:1===e.getUint8(5)?"A":"B"}}}},659(e,t,a){Object.defineProperty(t,"__esModule",{value:!0}),t.PingPongAI=void 0;const s=a(369);t.PingPongAI=class{constructor(e){this.ball={x:0,y:0,z:0,vx:0,vy:0,vz:0,spin:0},this.paddle={x:0,y:0,vx:0,vy:0},this.isServing=!0,this.currentServer="A",this.TABLE_WIDTH=300,this.TABLE_LENGTH=480,this.BAT_Y_A=240,this.BAT_Y_B=-240,this.MOVE_SPEED=250,this.difficulty=.8,this.lastUpdate=0,this.lastHitTime=0,this.role=e,this.paddle.y=this.BAT_Y_A,this.paddle.x=0,this.currentServer===this.role&&this.prepareServe()}toNetwork(e){return"B"===this.role?{x:-e.x,y:-e.y,z:e.z,vx:-e.vx,vy:-e.vy,vz:e.vz,spin:e.spin}:e}prepareServe(){this.currentServer===this.role&&(this.isServing=!0,this.ball={x:0,y:this.paddle.y-20,z:80,vx:0,vy:0,vz:0,spin:0})}fromNetwork(e){return"B"===this.role?{x:-e.x,y:-e.y,z:e.z,vx:-e.vx,vy:-e.vy,vz:e.vz,spin:e.spin}:e}onMessage(e){const t=s.NetworkProtocol.decode(e);if(t)if(console.log("[PingPongAI] Received message:",t.type),"hit"===t.type){const e=this.fromNetwork(t.state);console.log("[PingPongAI] Hit received, ball:",e.x,e.y,"vy:",e.vy),this.ball={...e},this.isServing=t.isServing}else"score"===t.type&&(this.currentServer=t.currentServer,this.currentServer===this.role?this.prepareServe():this.isServing=!1)}tick(e){const t=[],a=Date.now();this.simulateBall(e),this.isServing&&this.currentServer===this.role?a-this.lastHitTime>1e3&&this.performServe(t):(this.updatePaddleMovement(e),this.checkCollision(t));const n="B"===this.role?-this.paddle.x:this.paddle.x,i="B"===this.role?-this.paddle.y:this.paddle.y,o="B"===this.role?-this.paddle.vx:this.paddle.vx,l="B"===this.role?-this.paddle.vy:this.paddle.vy;return t.push(s.NetworkProtocol.encodeBatUpdate({role:this.role,x:n,y:i,vx:o,vy:l})),this.lastUpdate=a,t}simulateBall(e){this.ball.vz-=400*e,this.ball.x+=this.ball.vx*e,this.ball.y+=this.ball.vy*e,this.ball.z+=this.ball.vz*e,this.ball.z<0&&(this.ball.z=0,this.ball.vz=.9*-this.ball.vz,Math.abs(this.ball.vz)<50&&(this.ball.vz=0))}updatePaddleMovement(e){let t=0;if(this.ball.vy>0){t=this.ball.x;const e=this.TABLE_WIDTH/2+50;t>e&&(t=e),t<-e&&(t=-e)}else t=0;const a=t-this.paddle.x,s=this.MOVE_SPEED*e;if(Math.abs(a)<s)this.paddle.x=t,this.paddle.vx=a/e;else{const e=Math.sign(a);this.paddle.x+=e*s,this.paddle.vx=e*this.MOVE_SPEED}}checkCollision(e){const t=Date.now();if(t-this.lastHitTime<500)return;const a=Math.abs(this.ball.y-this.paddle.y),n=Math.abs(this.ball.x-this.paddle.x);if(a<30&&n<40&&this.ball.z<100){if(!(this.ball.vy>0))return;this.lastHitTime=t;const a=(Math.random()-.5)*(.8*this.TABLE_WIDTH),n=-(this.TABLE_LENGTH/2-40),i=450;this.ball.vy=-i;const o=Math.abs((n-this.ball.y)/this.ball.vy);this.ball.vx=(a-this.ball.x)/o,this.ball.vz=250,e.push(s.NetworkProtocol.encodeHitEvent({state:this.toNetwork(this.ball),isServing:!1}))}}performServe(e){this.lastHitTime=Date.now(),this.ball.x=this.paddle.x,this.ball.y=this.paddle.y-20,this.ball.z=80,this.ball.vy=-400,this.ball.vx=100*(Math.random()-.5),this.ball.vz=200,this.isServing=!1,e.push(s.NetworkProtocol.encodeHitEvent({state:this.toNetwork(this.ball),isServing:!0}))}}},673(e,t,a){Object.defineProperty(t,"__esModule",{value:!0}),t.BotClient=void 0;const s=a(659);t.BotClient=class{constructor(e,t=""){this.gameAI=null,this.role="B",this.gameLoopInterval=null,this.gameChannelReliable=null,this.gameChannelUnreliable=null,this.chatChannel=null,this.persona=e,this.backendUrl=t||window.location.origin,console.log(`[BotClient] Created bot: ${e.name}`)}getPersona(){return this.persona}setRole(e){this.role=e,this.gameAI=new s.PingPongAI(e),console.log(`[BotClient] Role set to ${e}, initialized PingPongAI`)}setupGameChannel(e){const t=e.label;console.log(`[BotClient] Setting up game channel: ${t}`),"game_reliable"===t?this.gameChannelReliable=e:this.gameChannelUnreliable=e,e.binaryType="arraybuffer",e.onopen=()=>{console.log(`[BotClient] Game channel ${t} OPEN`),"game_unreliable"!==t&&this.gameChannelReliable||this.startGameLoop()},e.onmessage=e=>{if(this.gameAI){let t;if(e.data instanceof ArrayBuffer)t=e.data;else{if(e.data instanceof Blob)return void e.data.arrayBuffer().then(e=>{var t;null===(t=this.gameAI)||void 0===t||t.onMessage(e)});t=e.data}this.gameAI.onMessage(t)}},e.onclose=()=>{console.log(`[BotClient] Game channel ${t} CLOSED`),"game_unreliable"===t&&this.stopGameLoop()}}setupChatChannel(e){this.chatChannel=e,e.onopen=()=>{console.log("[BotClient] Chat channel OPEN"),this.sendBotInfo(),this.sendGreeting()},e.onmessage=async e=>{await this.handleChatMessage(e.data)},e.onclose=()=>{console.log("[BotClient] Chat channel CLOSED")}}startGameLoop(){this.gameLoopInterval&&clearInterval(this.gameLoopInterval),console.log("[BotClient] Starting game loop"),this.gameLoopInterval=window.setInterval(()=>{const e=this.gameChannelUnreliable||this.gameChannelReliable;if(this.gameAI&&e&&"open"===e.readyState){const t=1/60;this.gameAI.tick(t).forEach(t=>{try{e.send(t)}catch(e){}})}},1e3/60)}stopGameLoop(){this.gameLoopInterval&&(clearInterval(this.gameLoopInterval),this.gameLoopInterval=null)}sendBotInfo(){if(this.chatChannel&&"open"===this.chatChannel.readyState){const e={type:"bot_info",payload:{id:this.persona.id,name:this.persona.name,avatar:this.persona.avatar}};this.chatChannel.send(JSON.stringify(e))}}async sendGreeting(){try{const e=await this.getLLMResponse(`Say a short, friendly greeting as ${this.persona.name}. Just one sentence, be casual and welcoming.`);this.chatChannel&&"open"===this.chatChannel.readyState&&this.chatChannel.send(JSON.stringify({type:"chat",payload:e,sender:"bot"}))}catch(e){console.error("[BotClient] Greeting error:",e),this.chatChannel&&"open"===this.chatChannel.readyState&&this.chatChannel.send(JSON.stringify({type:"chat",payload:`Hey there! I'm ${this.persona.name}. Nice to meet you! ðŸ‘‹`,sender:"bot"}))}}async handleChatMessage(e){try{const t="string"==typeof e?e:(new TextDecoder).decode(e);let a=t;try{const e=JSON.parse(t);if("game_invite"===e.type)return console.log("[BotClient] Received game invite:",e.payload),void(this.chatChannel&&"open"===this.chatChannel.readyState&&(console.log("[BotClient] Auto-accepting game invite"),this.chatChannel.send(JSON.stringify({type:"game_accept",payload:e.payload}))));if("game_accept"===e.type||"game_reject"===e.type||"game_leave"===e.type||"game_cancel"===e.type)return void console.log("[BotClient] Game control message:",e.type);if("chat"===e.type)a=e.payload;else if(e.content)a=e.content;else{if(!e.message)return;a=e.message}}catch(e){}const s=await this.getLLMResponse(a),n=Math.min(Math.max(30*s.length,2e3),5e3);await new Promise(e=>setTimeout(e,n)),this.chatChannel&&"open"===this.chatChannel.readyState&&this.chatChannel.send(JSON.stringify({type:"chat",payload:s,sender:"bot"}))}catch(e){console.error("[BotClient] Chat error:",e)}}sendTypingIndicator(e){this.chatChannel&&"open"===this.chatChannel.readyState&&this.chatChannel.send(JSON.stringify({type:"typing",payload:{isTyping:e}}))}async getLLMResponse(e){try{const t=await fetch(`${this.backendUrl}/api/bot-chat`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({systemPrompt:this.persona.systemPrompt,message:e})});if(!t.ok)throw new Error(`API error: ${t.status}`);return(await t.json()).response||"Hmm, let me think..."}catch(e){console.error("[BotClient] LLM API error:",e);const t=["Nice move!","Good game!","Let's keep playing!","You're doing great!","That was close!"];return t[Math.floor(Math.random()*t.length)]}}cleanup(){this.stopGameLoop(),this.gameChannelReliable&&(this.gameChannelReliable.close(),this.gameChannelReliable=null),this.gameChannelUnreliable&&(this.gameChannelUnreliable.close(),this.gameChannelUnreliable=null),this.chatChannel&&(this.chatChannel.close(),this.chatChannel=null),this.gameAI=null,console.log("[BotClient] Cleaned up")}}}},t={};function a(s){var n=t[s];if(void 0!==n)return n.exports;var i=t[s]={exports:{}};return e[s](i,i.exports,a),i.exports}var s={};return(()=>{var e=s;const t=a(673);a(659),a(369);e.default=t.BotClient})(),s.default})());